<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Playground</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Announce important status updates to screen readers -->
        <div id="aria-announcer" aria-live="assertive" aria-atomic="true" class="sr-only"></div>
        
        <!-- Skip links for keyboard navigation -->
        <a href="#chat-messages" class="skip-link">Skip to main chat content</a>
        
        <header>
            <h1>Chat playground</h1>
        </header>
        
        <div class="chat-container" role="main">
            <!-- Setup Panel -->
            <div class="setup-panel" role="region" aria-label="Chat configuration panel">
                <div class="setup-content">
                    <div class="model-section">
                        <label for="model-select">Model</label>
                        <div class="model-select-wrapper">
                            <select id="model-select" disabled aria-describedby="model-select-desc">
                                <option value="">Loading models...</option>
                            </select>
                            <button class="parameters-btn" id="parameters-btn" title="Parameters" aria-label="Open parameters settings" tabindex="0">&#128880;</button>
                        </div>
                        <div id="model-select-desc" class="sr-only">Select an AI model to chat with</div>
                        
                        <div class="progress-container" id="progress-container" role="progressbar" aria-live="polite" aria-label="Model download progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="progress-text" id="progress-text">Downloading model: 0%</div>
                        </div>
                    </div>
                    
                    <div class="instructions-section">
                        <label for="system-message">Instructions</label>
                        <textarea id="system-message" rows="3" disabled aria-describedby="system-message-desc">You are an AI assistant that helps people find information.</textarea>
                        <div id="system-message-desc" class="sr-only">Set custom instructions that will guide the AI model's behavior and responses</div>
                    </div>
                    
                    <div class="collapsible-section">
                        <button class="collapsible-btn" onclick="toggleSection('add-data')" aria-expanded="true" aria-controls="add-data" aria-label="Tools section, currently expanded" tabindex="0">
                            ‚ñº Tools
                        </button>
                        <div class="collapsible-content" id="add-data" style="display: block;" role="region" aria-labelledby="add-data-header">
                            <div class="data-upload-section" id="add-data-header">
                                <p class="section-description">Upload a text file to provide additional context for the AI model.</p>
                                
                                <button class="add-data-btn" id="add-data-btn" onclick="triggerFileUpload()" aria-describedby="upload-constraints">
                                    Upload files
                                </button>
                                
                                <input type="file" id="file-input" accept=".txt" style="display: none;" aria-label="Select text file to upload">
                                
                                <div class="file-info" id="file-info" style="display: none;" role="status" aria-live="polite">
                                    <div class="file-details">
                                        <span class="file-name" id="file-name" aria-label="Uploaded file name"></span>
                                        <span class="file-size" id="file-size" aria-label="File size"></span>
                                    </div>
                                    <button class="remove-file-btn" id="remove-file-btn" onclick="removeFile()" aria-label="Remove uploaded file">üóëÔ∏è</button>
                                </div>
                                
                                <div class="upload-constraints" id="upload-constraints" role="note">
                                    <small>‚Ä¢ Text files (.txt) only</small>
                                    <small>‚Ä¢ Maximum size: 3KB</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="image-analysis-section">
                        <h4>Image analysis</h4>
                        <p class="section-description">Enable the model to analyze and describe images.</p>
                        <div class="toggle-switch purple-toggle">
                            <input type="checkbox" id="image-analysis-toggle" aria-describedby="image-analysis-desc">
                            <label for="image-analysis-toggle" class="switch-label">
                                <span class="switch-slider" aria-hidden="true"></span>
                                <span class="switch-text">Enable image analysis</span>
                            </label>
                            <div id="image-analysis-desc" class="sr-only">Toggle to enable AI analysis of uploaded images</div>
                        </div>
                        
                        <div class="vision-progress-container" id="vision-progress-container" style="display: none;" role="progressbar" aria-live="polite" aria-label="Model download progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="vision-progress-fill"></div>
                            </div>
                            <div class="progress-text" id="vision-progress-text">Downloading MobileNet model...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Panel -->
            <div class="chat-panel" role="region" aria-label="Chat interface">
                <div class="chat-header">
                    <h3>Chat</h3>
                    <div class="chat-controls">
                        <button class="icon-btn" title="New chat" aria-label="Start new chat" tabindex="0">&#128172;</button>
                        <button class="icon-btn help-btn" title="About this app" aria-label="About this app" tabindex="0">?</button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages" role="log" aria-live="polite" aria-label="Chat conversation">
                    <div class="welcome-message">
                        <div class="chat-icon" aria-hidden="true">üí¨</div>
                        <h3>What do you want to chat about?</h3>
                    </div>
                </div>
                
                <div class="chat-input-container" role="region" aria-label="Message input area">
                    <div class="input-wrapper">
                        <div class="input-thumbnail-container" id="input-thumbnail-container" style="display: none;" role="status" aria-live="polite">
                            <img id="input-thumbnail" alt="Selected image thumbnail for analysis">
                            <button class="remove-thumbnail-btn" id="remove-thumbnail-btn" title="Remove image" aria-label="Remove selected image">üóëÔ∏è</button>
                        </div>
                        <textarea 
                            id="user-input" 
                            placeholder="Chat with the model..."
                            rows="1"
                            disabled
                            aria-label="Type your message to the AI assistant"
                            aria-describedby="input-help"
                        ></textarea>
                        <div id="input-help" class="sr-only">Use Shift+Enter for new lines. Press Enter or click send to submit your message.</div>
                        <button class="attach-btn" title="Upload image" id="attach-btn" disabled aria-label="Upload image for analysis">üìé</button>
                        <button id="send-btn" disabled aria-label="Send message">‚û§</button>
                    </div>
                    <div class="input-info">
                        <span class="disclaimer" aria-label="Disclaimer: AI-generated content may be incorrect" role="status">AI-generated content may be incorrect</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Parameters Modal -->
    <div class="modal-overlay" id="parameters-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="parameters-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="parameters-modal-title">Parameters</h2>
                <button class="modal-close-btn" onclick="closeParametersModal()" aria-label="Close parameters dialog">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="parameter-group">
                    <label for="modal-temperature-slider">Temperature</label>
                    <div class="slider-container">
                        <input type="range" id="modal-temperature-slider" min="0" max="2" step="0.1" value="0.7" class="parameter-slider" aria-describedby="modal-temperature-desc" aria-valuetext="0.7">
                        <span class="slider-value" id="modal-temperature-value" aria-live="polite">0.7</span>
                    </div>
                    <div class="parameter-description" id="modal-temperature-desc">Controls randomness. Lower = more focused, Higher = more creative</div>
                </div>
                
                <div class="parameter-group">
                    <label for="modal-top-p-slider">Top P</label>
                    <div class="slider-container">
                        <input type="range" id="modal-top-p-slider" min="0" max="1" step="0.05" value="0.9" class="parameter-slider" aria-describedby="modal-top-p-desc" aria-valuetext="0.9">
                        <span class="slider-value" id="modal-top-p-value" aria-live="polite">0.9</span>
                    </div>
                    <div class="parameter-description" id="modal-top-p-desc">Nucleus sampling. Controls diversity of word choices</div>
                </div>
                
                <div class="parameter-group">
                    <label for="modal-max-tokens-slider">Max Tokens</label>
                    <div class="slider-container">
                        <input type="range" id="modal-max-tokens-slider" min="50" max="2000" step="50" value="1000" class="parameter-slider" aria-describedby="modal-max-tokens-desc" aria-valuetext="1000">
                        <span class="slider-value" id="modal-max-tokens-value" aria-live="polite">1000</span>
                    </div>
                    <div class="parameter-description" id="modal-max-tokens-desc">Maximum length of the response</div>
                </div>
                
                <div class="parameter-group">
                    <label for="modal-repetition-penalty-slider">Repetition Penalty</label>
                    <div class="slider-container">
                        <input type="range" id="modal-repetition-penalty-slider" min="0.5" max="2" step="0.1" value="1.1" class="parameter-slider" aria-describedby="modal-repetition-penalty-desc" aria-valuetext="1.1">
                        <span class="slider-value" id="modal-repetition-penalty-value" aria-live="polite">1.1</span>
                    </div>
                    <div class="parameter-description" id="modal-repetition-penalty-desc">Reduces repetitive text. Higher values = less repetition</div>
                </div>
                
                <div class="parameter-actions">
                    <button class="reset-btn" onclick="resetParametersFromModal()" aria-label="Reset all parameters to default values">Reset to Defaults</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeParametersModal()" aria-label="Close parameters modal">Close</button>
            </div>
        </div>
    </div>
    
    <!-- About Modal -->
    <div class="modal-overlay" id="about-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="about-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="about-modal-title">About this app</h2>
                <button class="modal-close-btn" onclick="closeAboutModal()" aria-label="Close about dialog">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="about-content">
                    <div class="highlighted-note">
                        <p>üìã <a href="https://microsoftlearning.github.io/ai-apps/" target="_blank" rel="noopener noreferrer">Important details and AI transparency notes</a></p>
                    </div>
                    
                    <p>This app is designed as a learning aid for anyone seeking to become familiar with Generative AI apps and agents. It's based on the user interface in Microsoft Foundry portal, but does not use any Azure cloud services.</p>
                    
                    <p>The app uses AI language models for both GPU and CPU modes. For GPU mode, it uses Microsoft's <strong>Phi-3-mini</strong> via WebLLM (requires WebGPU API and GPU). For CPU mode, it uses <strong>SmolLM2</strong> via wllama/WebAssembly (works on any device). If WebLLM fails to load, the app automatically falls back to CPU mode. You can switch between modes using the Model dropdown.</p>
                    
                    <p>The app also makes use of the MobileNetV3 model and the TensorFlow.js framework to implement image classification.</p>
                    
                    <h3>Known issues</h3>
                    <ul>
                        <li>The initial download of the Microsoft Phi model may take a few minutes - particularly on low-bandwidth connections. Subsequent downloads should be quicker.</li>
                        <li>Some GPU-enabled computers (particularly those with ARM-based processors) do not support WebGPU without enabling the <strong>Unsafe WebGPU Support</strong> browser flag. If your browser fails to load the Microsoft Phi model, you can try enabling this flag at <a href="edge://flags" style="color: #0078d4; text-decoration: underline;" target="_blank">edge://flags</a> on Microsoft Edge or <a href="chrome://flags" style="color: #0078d4; text-decoration: underline;" target="_blank">chrome://flags</a> on Google Chrome. Disable it again when finished!</li>
                        <li>CPU mode (SmolLM2) response times are slower than GPU mode (Phi-3-mini). SmolLM2 is a smaller 360M parameter model optimized for browser performance. Use the Model dropdown to select your preferred mode.</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeAboutModal()" aria-label="Close about dialog">Close</button>
            </div>
        </div>
    </div>
    
    <script type="module" src="script.js?v=47"></script>
</body>
</html>